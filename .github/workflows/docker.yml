name: Docker

on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        default: ubuntu-22.04
      context:
        required: false
        type: string
        default: ./
      dockerfile:
        required: false
        type: string
        default: ./Dockerfile
      target:
        required: false
        type: string
        default: ""
      suffix:
        required: false
        type: string
        default: ""

jobs:
  docker:
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Login to Registry
        uses: docker/login-action@0d4c9c5ea7693da7b068278f7b52bda2a190a446
        with:
          registry: ghcr.io
          username: x-oauth-token
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29
      - name: Get Image Tag
        id: tag
        env:
          DOCKER_BUILDKIT: "1"
          TARGET: ${{ inputs.target }}
          SUFFIX: ${{ inputs.suffix }}
        run: |
          tag="ghcr.io/$GITHUB_REPOSITORY"
          if [ -n "$SUFFIX" ]; then
            tag="$tag/$SUFFIX"
          fi
          if [ -n "$TARGET" ]; then
            tag="$tag/$TARGET"
          fi
          tag="$tag:$GITHUB_SHA"
          echo "::set-output name=tag::$tag"
          echo "$tag"
      - name: Build Image
        env:
          DOCKER_BUILDKIT: "1"
          DOCKERFILE: ${{ inputs.dockerfile }}
          TARGET: ${{ inputs.target }}
          CONTEXT: ${{ inputs.context }}
          TAG: ${{ steps.tag.outputs.tag }}
        run: docker build --tag "$TAG" --file "$DOCKERFILE" --target "$TARGET" "$CONTEXT"
      - name: Push Image
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: docker push "$TAG"
